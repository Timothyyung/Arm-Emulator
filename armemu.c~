#include <stdbool.h>
#include <stdio.h>

#define NREGS 16
#define STACK_SIZE 1024
#define SP 13
#define LR 14
#define PC 15

int add_s(int a, int b);

struct arm_state {
    unsigned int regs[NREGS];
    unsigned int cpsr;
    unsigned char stack[STACK_SIZE];
};

struct instruction{
    unsigned int rd;
    unsigned int rn;
    unsigned int rm;
    unsigned int imm;
    unsigned int rot;
    unsigned int s;
};

void arm_state_init(struct arm_state *as, unsigned int *func,
                    unsigned int arg0, unsigned int arg1,
                    unsigned int arg2, unsigned int arg3)
{
    int i;
    /* zero out all arm state */
    for (i = 0; i < NREGS; i++) {
        as->regs[i] = 0;
    }

    as->cpsr = 0;

    for (i = 0; i < STACK_SIZE; i++) {
        as->stack[i] = 0;
    }

    as->regs[PC] = (unsigned int) func;
    as->regs[SP] = (unsigned int) &as->stack[STACK_SIZE];
    as->regs[LR] = 0;

    as->regs[0] = arg0;
    as->regs[1] = arg1;
    as->regs[2] = arg2;
    as->regs[3] = arg3;
}

void arm_state_print(struct arm_state *as)
{
    int i;

    for (i = 0; i < NREGS; i++) {
        printf("reg[%d] = %d\n", i, as->regs[i]);
    }
    printf("cpsr = %X\n", as->cpsr);
}

unsigned int maskgen(unsigned int size)
{
    unsigned int mask;
    for(int i = 0; i < size; i++){
	mask = mask & 1;
	if(i + 1 < size)
	    mask = mask << 1;
    }
    return mask;
}

unsigned int rotation(unsigned int rot, unsigned int imml){
    unsigned long int shift;
    unsigned long int temp;
    rot = rot * 2;
    shift = 32 - rot;
    temp = (maskgen(rot) & imml) << shift;
    printf("%d\n",temp);
    return (temp | (imml >> rot));
}

bool check_inst(unsigned int iw, unsigned int code)
{
 
    unsigned int op;
    unsigned int opcode;

    op = (iw >> 26) & 0b11;
    opcode = (iw >> 21) & 0b1111;

    return (op == 0) && (opcode == code);   
}

void read_inst(unsigned int iw,struct instruction *inst )
{
    inst->imm = (iw >> 25) &0b1;
    inst->rd = (iw >> 12) & 0xF;
    inst->rn = (iw >> 16) & 0xF;
    inst->rm = iw & 0xFF;
    inst->rot = (iw >> 8) & 0xF;
}

bool is_add_inst(unsigned int iw)
{
    return check_inst(iw,0b0100);
}

void armemu_add(struct arm_state *state)
{
    unsigned int iw;
    struct instruction inst;

    iw = *((unsigned int *) state->regs[PC]);
    read_inst(iw,&inst);
    if(inst.imm == 0)
    {
	state->regs[inst.rd] = state->regs[inst.rn] + state->regs[inst.rm];
    }else
	state->regs[inst.rd] = state->regs[inst.rn] + rotation(inst.rot,inst.rm);
    if (inst.rd != PC) {
        state->regs[PC] = state->regs[PC] + 4;
    }
}

bool is_sub_inst(unsigned int iw)
{
    return check_inst(iw, 0b0010);
}

void armemu_sub(struct arm_state *state)
{
    unsigned int iw;
    struct instruction inst;
    
    iw = *((unsigned int *) state->regs[PC]);
    read_inst(iw,&inst);

    if(inst.imm == 0)
    {
	state->regs[inst.rd] = state->regs[inst.rn] - state->regs[inst.rm];
    }else
	state->regs[inst.rd] = state->regs[inst.rn] - rotation(inst.rot,inst.rm);
    if (inst.rd != PC) {
        state->regs[PC] = state->regs[PC] + 4;
    }
}

bool is_cmp_inst(unsigned int iw)
{
    check_inst(iw,0b1010);
}

unsigned int set_flags(unsigned int value)
{
    unsigned int n,z;
    if(value == 0)
	z = 1 << 30;
    if((value >> 31) & 1 == 1)
	n = 1 << 31;
    return z|n;
}

void armemu_cmp(struct arm_state *state)
{
    unsigned int iw;
    unsigned int value;
    struct instruction inst;
    iw = *((unsigned int *) state->regs[PC]);
    read_inst(iw,&inst);

    if(inst.imm == 0)
	value = state->regs[inst.rn] - state->regs[inst.rm];
    else
	value = state->regs[inst.rn] - rotation(inst.rot,inst.rm);
    
    state->cpsr = set_flags(value);

    state->regs[PC] = state->regs[PC] + 4;

}

bool is_mov_inst(unsigned int iw)
{
    return check_inst(iw,0b1101);
}
		    
void armemu_mov(struct arm_state *state)
{
    unsigned int iw;
    struct instruction inst;
    iw = *((unsigned int *) state->regs[PC]);
    read_inst(iw,&inst);
    
    if (inst.imm == 0)
	state->regs[inst.rd] = state->regs[inst.rm];
    else
	state->regs[inst.rd] = rotation(inst.rot,inst.rm);
    if( inst.rd != PC) {
	state->regs[PC] = state->regs[PC] + 4;
    }
}

bool check_branch(unsigned int iw)
{
    unsigned int cond;
    unsigned int branch;
    unsigned int linkbit;
    printf("halp \n\n");
    cond = (iw >> 28) & 0b1111;
    branch = (iw >> 26) & 0b11;
    linkbit = (iw >> 24) & 0b11;
    
    printf("cond = %d, branch = %d, linkbit = %d\n",cond,branch,linkbit);

    return (cond == 0) && (branch == 0b10) && (linkbit == 0b10);
}

bool is_beq_inst(unsigned int iw)
{
    return check_branch(iw);
}

void armemu_beq(struct arm_state *state)
{
    printf("help\n");
    unsigned int iw;
    iw = *((unsigned int *) state->regs[PC]);
    printf("%x\n", iw);
    if(((state->cpsr >> 30) & 1) == 1)
    {
	state->regs[LR] = state->regs[PC];
	state->regs[PC] = ((iw & 0xFFFFFF) << 2) + 4;
	printf("suck it\n");
    }else
	state->regs[PC] = state->regs[PC] + 4;
	
}

bool is_bx_inst(unsigned int iw)
{
    unsigned int bx_code;

    bx_code = (iw >> 4) & 0x00FFFFFF;

    return (bx_code == 0b000100101111111111110001);
}

void armemu_bx(struct arm_state *state)
{
    unsigned int iw;
    unsigned int rn;

    iw = *((unsigned int *) state->regs[PC]);
    rn = iw & 0b1111;

    state->regs[PC] = state->regs[rn];
}

void armemu_one(struct arm_state *state)
{
    unsigned int iw;
    printf("%x\n\n", state->regs[PC]);    
    iw = *((unsigned int *) state->regs[PC]);
    printf("%x\n\n", iw);
    if (is_bx_inst(iw)) {
        armemu_bx(state);
    } else if (is_add_inst(iw)) {
        armemu_add(state);
    } else if (is_mov_inst(iw)) {
	armemu_mov(state);
    } else if (is_sub_inst(iw)) {
	armemu_sub(state);
    } else if (is_cmp_inst(iw)) {
	armemu_cmp(state);
    } else if (is_beq_inst(iw)) {
	armemu_beq(state);
    }
}
	
unsigned int armemu(struct arm_state *state)
{
    while (state->regs[PC] != 0) {
	printf("im game\n");
        armemu_one(state);
    }
    return state->regs[0];
}
                      
int main(int argc, char **argv)
{
    struct arm_state state;
    unsigned int r;
    
    arm_state_init(&state, (unsigned int *) add_s, 4, 2, 3, 0);
    arm_state_print(&state);
    r = armemu(&state);
    printf("r = %d\n", r);
    arm_state_print(&state);
  
    return 0;
}
